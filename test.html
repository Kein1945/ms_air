<!DOCTYPE html>
<html>
<head>
  <!-- Framework -->
        <script type="text/javascript" src="js/AIRAliases.js"></script>
        <script type="text/javascript" src="js/jquery.js"></script>
        <script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
        <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css"/>
  <!-- END Framework -->
        <script type="text/javascript" src="js/util.js"></script>
        <script type="text/javascript" src="js/cil.protocol.js"></script>
        <script type="text/javascript" src="js/connection.js"></script>
  
        <link rel="stylesheet" type="text/css" href="style.css"/>
<title>Mobile secretary</title>
<!-- this is stable version -->
</head>

<body>
<script>
var result = {
        connect : false
        , messageReceived : false
        , exceptionCaught : false
}

var HelloPacket = cil_protocol.addPacketPrototype(1, cil_protocol.makePacketPrototype(1, "Hello", {
                send: function(c) { c.write(1) }
                , get: function(c) {
                        Trace("Hello received")
                }
        })
)

var AuthorizePacket = cil_protocol.addPacketPrototype(4, cil_protocol.makePacketPrototype( 4, 'Authorize', {

                setLogin: function(login){ this.login = login }
                ,setPassword : function(password){ this.password = password }
                ,setInstrument : function(instrument){ this.instrument = instrument }
                ,setExtension : function(extension){ this.extension = extension }
                ,send : function(channel){
                        
                        if( this.login.length && this.password.length && this.instrument.length && this.extension ){
                                channel.write( this.login )
                                channel.write( this.password )
                                channel.write( this.instrument )
                                channel.write( this.extension )
                        } else {
                                Trace("Authorize packet required set login, password, instrument, extension")
                        }
                }
                ,get : function(channel){
                        // for (var i in channel){
                        //         if( this.hasOwnProperty(i) )
                        //                 air.trace(i+' is '+ channel[i] + '['+typeof(channel[i])+']')
                        // }
                        this.code = channel.readInt()
                        this.message = channel.readString()
                }
                , getInfo: function(){
                        return this.getLabel() + (
                                                'undefined'==typeof(this.code)
                                                        ?(this.login+':'+this.password+'@'+this.instrument+'/'+this.extension)
                                                        :(' ['+ this.message + '/' + this.code+']')
                                        )
                }
        })
        )

var c = new Connect( { host: '127.0.0.1', port: 32562}, [{
        channelConnected : function(ctx){
                Trace("Connect")
                ctx.getChannel().write( new HelloPacket() )
        }
        , channelDisconnected: function(ctx){
                for (var k in result )
                        Trace( k+ " : "+result[k])
        }
        , messageReceived : function(packet, ctx){
                switch(packet.getName()){
                        case "Hello":
                                var p = new AuthorizePacket()
                                p.setLogin('bsalmanov')
                                p.setPassword('123654')
                                p.setInstrument('56704')
                                p.setExtension(5000)
                                ctx.getChannel().write( p )
                        break;
                        case "Authorize":
                                Trace("Authorized")
                }
        }
        , exceptionCaught: function(e){
                throw e
        }

} , 
new cil_protocol.encoder() , 
new cil_protocol.decoder()
])
c.connect()
</script>
</body>
</html>